<!-- saved from url=(0092)https://cryptonomic.tech/_matrix/media/r0/download/cryptonomic.tech/iMTLWSuCVJbIoqrjaBHKRXdl -->
<html>
    <head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script
	    src="https://cdn.jsdelivr.net/gh/cryptonomic/conseiljs/dist-web/conseiljs.min.js"
	    integrity="sha384-1Lpjkva0cskGzGmrvU+WIbzNk24LwcaEFgsukzbI5wTl7T6kom1UA4DKS/oxtaqr"
	    crossorigin="anonymous">
	</script>

	<script>
	 const conseilServer = { url: 'https://conseil-staging.cryptonomic-infra.tech:443', apiKey: 'hooman' };
	 const platform = "tezos"
	 const network = "mainnet"
	

	 const stringOperators = [ { displayName: "is",   value: conseiljs.ConseilOperator.EQ }, 
				   { displayName: "in" , value: conseiljs.ConseilOperator.IN }, 
				   { displayName: "like", value: conseiljs.ConseilOperator.LIKE },
				   { displayName: "starts with", value: conseiljs.ConseilOperator.STARTSWITH },
				   { displayName:"ends with", value: conseiljs.ConseilOperator.ENDSWITH },
				   { displayName:"is null", value: conseiljs.ConseilOperator.ISNULL } ]
	 
	 const numberOperators = [ { displayName: "is",   value: conseiljs.ConseilOperator.EQ }, 
				   { displayName: "in" , value: conseiljs.ConseilOperator.IN }, 
				   { displayName: "between" , value: conseiljs.ConseilOperator.BETWEEN }, 
				   { displayName: "less than" , value: conseiljs.ConseilOperator.LT }, 
				   { displayName: "greater than" , value: conseiljs.ConseilOperator.GT } ]

	 const dateOperators = [ { displayName: "is",   value: conseiljs.ConseilOperator.EQ }, 
				 { displayName: "in" , value: conseiljs.ConseilOperator.IN }, 
				 { displayName: "between" , value: conseiljs.ConseilOperator.BETWEEN }, 
				 { displayName: "less than" , value: conseiljs.ConseilOperator.LT }, 
				 { displayName: "greater than" , value: conseiljs.ConseilOperator.GT },
				 { displayName: "before" , value: conseiljs.ConseilOperator.BEFORE }, 
				 { displayName: "after" , value: conseiljs.ConseilOperator.AFTER } ]

	 const stringDataTypes = [ "String", "Hash", "AccountAddress"]

	 function addOption(menu, text, value) {
	     var opt = document.createElement('option')
	     opt.value = value
	     opt.text = text
	     menu.options.add(opt)
	 }

	 function addOptions(menu, textAr, valueAr) {
	     menu.options.length = 0
	     addOption(menu, "pick a value", "pick a value")
	     for (i = 0; i < textAr.length; i++) {
		 addOption(menu, textAr[i], valueAr[i])
	     }
	 }

	 function createMenuInBody(elementId) {
	     var newMenu = document.createElement("select")
	     newMenu.setAttribute("id", elementId)
	     document.body.appendChild(newMenu)
	 }

	 function createTextboxInBody(elementId) {
	     var newMenu = document.createElement("input")
	     newMenu.setAttribute("id", elementId)
	     newMenu.setAttribute("type", "text")
	     document.body.appendChild(newMenu)
	 }

	 function resetMenus(toReset) {
	     let menus = document.getElementsByTagName("select")
	     for (i = 0; i < menus.length; i++) {
		 if (toReset.includes(menus[i].id)) {
		     menus[i].options.length = 0;
		 }
	     }
	 }

	 function deleteTextboxes() {
	     let textboxes = document.getElementsByTagName("input")
	     const length = textboxes.length
	     for (i = length-1; i >= 0; i--) {
		 textboxes[i].parentNode.removeChild(textboxes[i])
	     }
	 }

	 function deleteMenus(toDelete) {
	     let menus = document.getElementsByTagName("select")
	     const length = menus.length
	     for (i = length-1; i >= 0; i--) {
		 if (toDelete.includes(menus[i].id)) {
		     menus[i].parentNode.removeChild(menus[i])
		 }
	     }
	 }

	 function getObjectFromDisplayName(objArr, displayName) {
	     for (i = 0; i < objArr.length; i++) {
		 if (objArr[i].displayName == displayName) { return objArr[i] }
	     }
	 }

	 async function getQueryDetails() {
	     const entitiesMenu = document.getElementById("entities")
	     const attributesMenu = document.getElementById("attributes")
	     const predicatesMenu = document.getElementById("predicates")
	     
	     const entity = entitiesMenu.value
	     const attributesForEntity = await conseiljs.ConseilMetadataClient.getAttributes(conseilServer, platform, network, entity)
	     const attribute = getObjectFromDisplayName(attributesForEntity, attributesMenu.options[attributesMenu.selectedIndex].text).name
	     const operator = predicatesMenu.value
	     let predicates = []
	     
	     if (operator == conseiljs.ConseilOperator.BETWEEN) {
		 const beforeValue = document.getElementById("before").value
		 const afterValue = document.getElementById("after").value
		 const beforePredicate = createPredicate(attribute, conseiljs.ConseilOperator.BEFORE, beforeValue)
		 const afterPredicate = createPredicate(attribute, conseiljs.ConseilOperator.AFTER, afterValue)
		 predicates.push(beforePredicate)
		 predicates.push(afterPredicate)
	     }
	     else {
		 const value = document.getElementById("value").value
		 predicates.push(createPredicate(attribute, operator, value))
	     }

	     const query = {"entity" : entity,
			    "predicates" : predicates}

	     return query

	 }
	 
	 function createPredicate(attribute, operator, value) {
	     return { "attribute" : attribute, "operator" : operator, "value" : value }
	 }

	 async function executeQuery() {
	     const queryDetails = await getQueryDetails()
	     let query = conseiljs.ConseilQueryBuilder.blankQuery();
	     console.log(queryDetails)
	     for (let i = 0; i < queryDetails.predicates.length; i++) {
		 const predicate = queryDetails.predicates[i]
		 console.log(predicate)
		 query = conseiljs.ConseilQueryBuilder.addPredicate(query, predicate.attribute , predicate.operator, [predicate.value], false);
	     }

	     let response = await conseiljs.ConseilDataClient.executeEntityQuery(conseilServer, platform, network, queryDetails.entity, query);
	     console.log(response)
	 }
	 
	 async function initializeEntityMenu() {
	     const entities = await conseiljs.ConseilMetadataClient.getEntities(conseilServer, platform, network)
	     let entityMenu =  document.getElementById("entities")
	     entityNames = entities.map( entity => entity.name )
	     entityDisplayNames = entities.map( entity => entity.displayName ) 
	     addOptions(entityMenu, entityDisplayNames, entityNames)
	 }

	 async function initializeAtributeMenu(menu) {
	     resetMenus(["attributes", "predicates"])
	     deleteMenus(["value"])
	     deleteTextboxes()
	     const attributes = await conseiljs.ConseilMetadataClient.getAttributes(conseilServer, platform, network, menu.value)
	     let attributeMenu = document.getElementById("attributes")
	     const attributeDisplayNames = attributes.map( attribute => attribute.displayName )
	     const attributeDataTypes = attributes.map( attribute => attribute.dataType  ) 
	     addOptions(attributeMenu, attributeDisplayNames, attributeDataTypes)
	 }

	 async function initializePredicatesMenu(menu) {
	     resetMenus(["predicates"])
	     deleteMenus(["value"])	     
	     deleteTextboxes()
	     let predicatesMenu =  document.getElementById("predicates")
	     let operatorsAvailable = (stringDataTypes.includes(menu.value)) ?
				      stringOperators :
				      (menu.value == "DateTime") ?
				      dateOperators :
				      numberOperators

	     const predicateDisplayNames = operatorsAvailable.map( operator => operator.displayName )
	     const predicateValues = operatorsAvailable.map( operator => operator.value )


	     addOptions(predicatesMenu, predicateDisplayNames, predicateValues)

	 }

	 async function initializeValueMenus(menu) {
	     deleteMenus(["value"])
	     deleteTextboxes()
	     const entity = document.getElementById("entities").value

	     const attributes = await conseiljs.ConseilMetadataClient.getAttributes(conseilServer, platform, network, entity)
	     const attributesMenu = document.getElementById("attributes")
	     const attributeDisplayName = attributesMenu.options[attributesMenu.selectedIndex].text
	     const cardinality = getObjectFromDisplayName(attributes, attributeDisplayName).cardinality
	     const cardinalityThreshold = 20

	     if (menu.value == conseiljs.ConseilOperator.BETWEEN) {
		 createTextboxInBody("before")
		 createTextboxInBody("after")
	     }
	     else if (cardinality < cardinalityThreshold
		      && menu.value == conseiljs.ConseilOperator.EQ ) {
		 createMenuInBody("value")
		 populateValueMenu(document.getElementById("value"),
				   entity,
				   getObjectFromDisplayName(attributes, attributeDisplayName).name)
	     }
	     else { 
		 createTextboxInBody("value")
	     }
	 }

	 async function populateValueMenu(menu, entity, attribute) {
	     const attributeValues = await conseiljs.ConseilMetadataClient.getAttributeValues(conseilServer, platform, network, entity, attribute )
	     addOptions(menu, attributeValues, attributeValues)
	 }
	 
	</script>
	
    </head>
    <body onload="initializeEntityMenu()">    
	<button onclick="executeQuery()">Send</button><br>
	<br>
	<label for="entities">Show</label>
	<select id="entities" onchange="initializeAtributeMenu(this)">	</select>

	<label for="attributes"> where </label>
	<select id="attributes"  onChange="initializePredicatesMenu(this)"> </select>

	<label for="predicates"></label>
	<select id="predicates" onChange="initializeValueMenus(this)"> </select>



    </body>
</html>
